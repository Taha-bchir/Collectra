generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum WorkspaceRole {
  OWNER
  AGENT
}

enum DebtStatus {
  IMPORTED
  NOTIFIED
  PROMISED
  PAID
  OVERDUE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// Tables

model Workspace {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @unique
  website         String?
  createdByUserId String?  @db.Uuid // Who created this workspace
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdBy User?             @relation("CreatedWorkspaces", fields: [createdByUserId], references: [id])
  members   WorkspaceMember[]
  campaigns Campaign[]
  clients   Client[]
}

model User {
  id        String   @id @db.Uuid // Matches Supabase auth.users.id
  email     String   @unique
  fullName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdWorkspaces Workspace[]       @relation("CreatedWorkspaces")
  memberships       WorkspaceMember[]
}

model WorkspaceMember {
  userId      String        @db.Uuid
  workspaceId String        @db.Uuid
  role        WorkspaceRole
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([userId, workspaceId])
}

model Campaign {
  id          String         @id @default(uuid()) @db.Uuid
  workspaceId String         @db.Uuid
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  status      CampaignStatus @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  debts        Debt[]
  invitations  Invitation[]
  clientTokens ClientToken[]
}

model Client {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @db.Uuid
  fullName    String
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  debts     Debt[]
}

model Debt {
  id          String     @id @default(uuid()) @db.Uuid
  campaignId  String     @db.Uuid
  clientId    String     @db.Uuid
  amount      Decimal
  dueDate     DateTime
  status      DebtStatus @default(IMPORTED)
  promiseDate DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  clientTokens ClientToken[] @relation("DebtToClientTokens")
}

model Invitation {
  id         String           @id @default(uuid()) @db.Uuid
  campaignId String           @db.Uuid
  email      String
  role       WorkspaceRole    @default(AGENT)
  token      String           @unique
  expiresAt  DateTime
  status     InvitationStatus @default(PENDING)
  createdAt  DateTime         @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model ClientToken {
  id         String   @id @default(uuid()) @db.Uuid
  campaignId String   @db.Uuid
  debtId     String   @db.Uuid
  token      String   @unique
  expiresAt  DateTime @default(dbgenerated("now() + interval '7 days'"))
  createdAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  debt     Debt     @relation("DebtToClientTokens", fields: [debtId], references: [id], onDelete: Cascade)
}
