generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum WorkspaceRole {
  OWNER
  AGENT
}

enum PromiseStatus {
  ACTIVE // Promise made, waiting for due date
  KEPT // Paid on or before promised date
  BROKEN // Not paid by promised date
  CANCELLED // Manually cancelled by agent or customer
}

enum ActionType {
  LINK_SENT
  LINK_CLICKED
  PROMISE_MADE
  PROMISE_UPDATED
  PAYMENT_CONFIRMED
  STATUS_CHANGED
  NOTE_ADDED
  EMAIL_SENT
  SMS_SENT
  PHONE_CALL
  OTHER
}

enum DebtStatus {
  IMPORTED
  NOTIFIED
  PROMISE_TO_PAY        @map("PROMISED")
  PAID
  OVERDUE_AFTER_PROMISE @map("OVERDUE")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// Tables

model Workspace {
  id              String   @id @default(uuid()) @db.Uuid
  name            String
  website         String?
  createdByUserId String   @db.Uuid // Who created this workspace
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdBy User              @relation("CreatedWorkspaces", fields: [createdByUserId], references: [id], onDelete: Restrict)
  members   WorkspaceMember[]
  campaigns Campaign[]
  clients   Client[]

  @@unique([createdByUserId, name])
}

model User {
  id        String   @id @db.Uuid // Matches Supabase auth.users.id
  email     String   @unique
  fullName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdWorkspaces Workspace[]       @relation("CreatedWorkspaces")
  memberships       WorkspaceMember[]
}

model WorkspaceMember {
  userId      String        @db.Uuid
  workspaceId String        @db.Uuid
  role        WorkspaceRole
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([userId, workspaceId])
}

model Campaign {
  id          String         @id @default(uuid()) @db.Uuid
  workspaceId String         @db.Uuid
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  debts        DebtRecord[]
  invitations  Invitation[]
  clientTokens ClientToken[]
}

model Client {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @db.Uuid
  fullName    String
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace     Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  debts         DebtRecord[]
  actionHistory CustomerActionHistory[]
}

model DebtRecord {
  id             String     @id @default(uuid()) @db.Uuid
  campaignId     String     @db.Uuid
  clientId       String     @db.Uuid
  amount         Decimal
  dueDate        DateTime
  status         DebtStatus @default(IMPORTED)
  promiseDate    DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  customerToken  String?    @unique // secure UUID token for client link
  tokenExpiresAt DateTime? // optional: auto-expire after X days

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  clientTokens    ClientToken[]           @relation("DebtToClientTokens")
  paymentPromises PaymentPromise[]
  actionHistory   CustomerActionHistory[]

  @@map("Debt")
}

model Invitation {
  id         String           @id @default(uuid()) @db.Uuid
  campaignId String           @db.Uuid
  email      String
  role       WorkspaceRole    @default(AGENT)
  token      String           @unique
  expiresAt  DateTime
  status     InvitationStatus @default(PENDING)
  createdAt  DateTime         @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model ClientToken {
  id         String   @id @default(uuid()) @db.Uuid
  campaignId String   @db.Uuid
  debtId     String   @db.Uuid
  token      String   @unique
  expiresAt  DateTime @default(dbgenerated("now() + interval '7 days'"))
  createdAt  DateTime @default(now())

  campaign Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  debt     DebtRecord @relation("DebtToClientTokens", fields: [debtId], references: [id], onDelete: Cascade)
}

model PaymentPromise {
  id           String        @id @default(uuid()) @db.Uuid
  debtId       String        @db.Uuid
  promisedDate DateTime
  status       PromiseStatus @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  debt DebtRecord @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId])
  @@index([status]) // Quick filter: all broken promises, etc.
}

model CustomerActionHistory {
  id          String     @id @default(uuid()) @db.Uuid
  debtId      String?    @db.Uuid // optional â€“ some actions are customer-level only
  customerId  String     @db.Uuid
  actionType  ActionType
  timestamp   DateTime   @default(now())
  performedBy String?    @db.Uuid // userId of agent/owner who did it (nullable for client actions)
  metadata    Json? // flexible: { note: "...", oldStatus: "...", newStatus: "..." }
  createdAt   DateTime   @default(now())

  debt     DebtRecord? @relation(fields: [debtId], references: [id], onDelete: SetNull)
  customer Client      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, timestamp(sort: Desc)]) // Timeline per customer, newest first
  @@index([debtId])
  @@index([actionType])
}
